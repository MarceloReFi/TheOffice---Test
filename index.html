import React, { useState, useEffect } from 'react';
import { Home, Clipboard, User, X, Search, HelpCircle, LogOut, ArrowLeft, Loader2 } from 'lucide-react';

// Smart Contract Setup
const CONTRACT_ADDRESS = "0xf7317849bd10a41fbebd9edcd56f05e1d0b7ab2e";
const CUSD_ADDRESS = "0x765DE816845861e75A25fCA122bb6898B8B1282a";
const CELO_RPC = "https://forno.celo.org";

const CONTRACT_ABI = [
  "function createTask(string _taskId, address _token, uint256 _rewardPerSlot, uint256 _totalSlots, address _approver) external",
  "function claimTask(string _taskId) external",
  "function submitTask(string _taskId, string _proofHash) external",
  "function approveTask(string _taskId, address _claimant) external",
  "function claimReward(string _taskId) external",
  "function getTask(string _taskId) external view returns (tuple(string taskId, address creator, address approver, address token, uint256 rewardPerSlot, uint256 totalSlots, uint256 claimedSlots, bool active, uint256 createdAt))",
  "function getTaskSlot(string _taskId, address _claimant) external view returns (tuple(address claimant, uint256 reward, bool claimed, bool submitted, bool approved, bool withdrawn))",
  "function getAvailableSlots(string _taskId) external view returns (uint256)",
  "function approve(address spender, uint256 amount) external returns (bool)"
];

// Load ethers
const loadEthers = () => {
  return new Promise((resolve, reject) => {
    if (window.ethers) {
      resolve(window.ethers);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js';
    script.onload = () => resolve(window.ethers);
    script.onerror = reject;
    document.head.appendChild(script);
  });
};

// Cores
const colors = {
  navy: '#3A4571',
  purple: '#B88FD8',
  yellow: '#F2E885',
  green: '#7A8770',
  red: '#C4897B',
  pink: '#F5EBE9',
  black: '#000000',
  white: '#FFFFFF',
  gray: {
    50: '#F9FAFB',
    100: '#F3F4F6',
    200: '#E5E7EB',
    300: '#D1D5DB',
    600: '#4B5563',
    700: '#374151'
  }
};

const styles = {
  button: {
    primary: {
      backgroundColor: colors.navy,
      color: colors.white,
      padding: '12px 24px',
      fontWeight: 'bold',
      border: `2px solid ${colors.black}`,
      cursor: 'pointer',
      fontFamily: 'Courier, monospace',
      fontSize: '14px'
    },
    secondary: {
      backgroundColor: colors.white,
      color: colors.navy,
      padding: '12px 24px',
      fontWeight: 'bold',
      border: `2px solid ${colors.navy}`,
      cursor: 'pointer',
      fontFamily: 'Courier, monospace',
      fontSize: '14px'
    }
  },
  card: {
    backgroundColor: colors.white,
    border: `2px solid ${colors.black}`,
    padding: '20px'
  }
};

function Tooltip({ children, text }) {
  const [show, setShow] = useState(false);
  return (
    <div style={{ position: 'relative', display: 'inline-block' }}>
      <button
        onMouseEnter={() => setShow(true)}
        onMouseLeave={() => setShow(false)}
        onClick={() => setShow(!show)}
        style={{ background: 'none', border: 'none', cursor: 'help', padding: '4px' }}
      >
        {children}
      </button>
      {show && (
        <div style={{
          position: 'absolute',
          bottom: '100%',
          left: '50%',
          transform: 'translateX(-50%)',
          backgroundColor: colors.gray[700],
          color: colors.white,
          padding: '8px 12px',
          borderRadius: '4px',
          fontSize: '12px',
          whiteSpace: 'nowrap',
          zIndex: 100,
          marginBottom: '8px'
        }}>
          {text}
        </div>
      )}
    </div>
  );
}

function App() {
  const [account, setAccount] = useState(null);
  const [contract, setContract] = useState(null);
  const [cUSDContract, setCUSDContract] = useState(null);
  const [currentPage, setCurrentPage] = useState('home');
  const [showToast, setShowToast] = useState('');
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);
  const [loading, setLoading] = useState(false);
  const [balance, setBalance] = useState('0.00');
  
  const [tasks, setTasks] = useState([]);
  const [taskFilter, setTaskFilter] = useState('all');
  
  const [searchQuery, setSearchQuery] = useState('');
  const [taskId, setTaskId] = useState('');
  const [taskTitle, setTaskTitle] = useState('');
  const [taskDescription, setTaskDescription] = useState('');
  const [rewardPerSlot, setRewardPerSlot] = useState('');
  const [totalSlots, setTotalSlots] = useState('');
  const [proofUrl, setProofUrl] = useState('');

  const toast = (msg) => {
    setShowToast(msg);
    setTimeout(() => setShowToast(''), 3000);
  };

  // Setup wallet listeners - Register only once
  useEffect(() => {
    if (!window.ethereum) return;

    const handleAccountsChanged = async (accounts) => {
      console.log('üîÑ Account changed detected:', accounts);
      
      if (accounts.length === 0) {
        // User disconnected wallet
        console.log('‚ùå Wallet disconnected');
        setAccount(null);
        setContract(null);
        setCUSDContract(null);
        setTasks([]);
        setCurrentPage('home');
        toast('Wallet disconnected');
      } else {
        // User switched accounts - force reload for clean state
        const newAccount = accounts[0];
        console.log('üîÑ Switching to account:', newAccount);
        toast('Account changed - reloading...');
        setTimeout(() => window.location.reload(), 500);
      }
    };

    const handleChainChanged = (chainId) => {
      console.log('üîÑ Chain changed:', chainId);
      toast('Network changed - reloading...');
      setTimeout(() => window.location.reload(), 500);
    };

    // Register listeners
    console.log('‚úÖ Registering wallet listeners');
    window.ethereum.on('accountsChanged', handleAccountsChanged);
    window.ethereum.on('chainChanged', handleChainChanged);

    // Cleanup on unmount
    return () => {
      console.log('üßπ Cleaning up wallet listeners');
      window.ethereum.removeListener('accountsChanged', handleAccountsChanged);
      window.ethereum.removeListener('chainChanged', handleChainChanged);
    };
  }, []); // Empty array - register only once!

  // Load tasks from localStorage on mount
  useEffect(() => {
    if (account) {
      const savedTasks = localStorage.getItem(`theoffice_tasks_${account}`);
      if (savedTasks) {
        try {
          const parsed = JSON.parse(savedTasks);
          setTasks(parsed);
        } catch (error) {
          console.error('Error loading tasks:', error);
        }
      }
    }
  }, [account]);

  // Save tasks to localStorage when they change
  useEffect(() => {
    if (account && tasks.length > 0) {
      localStorage.setItem(`theoffice_tasks_${account}`, JSON.stringify(tasks));
    }
  }, [tasks, account]);

  const connectWallet = async () => {
    try {
      if (!window.ethereum) {
        toast('Please install MetaMask, Valora, or MiniPay');
        return;
      }

      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0xa4ec' }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0xa4ec',
              chainName: 'Celo Mainnet',
              nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
              rpcUrls: [CELO_RPC],
              blockExplorerUrls: ['https://celoscan.io']
            }]
          });
        }
      }

      toast('Loading Web3...');
      const ethers = await loadEthers();
      
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      
      const taskContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      const tokenContract = new ethers.Contract(CUSD_ADDRESS, CONTRACT_ABI, signer);

      setAccount(accounts[0]);
      setContract(taskContract);
      setCUSDContract(tokenContract);
      
      toast('‚úì Wallet connected!');
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    }
  };

  const getTask = async (id) => {
    if (!contract) return null;
    
    try {
      const ethers = window.ethers;
      const task = await contract.getTask(id);
      const availableSlots = await contract.getAvailableSlots(id);
      const mySlot = account ? await contract.getTaskSlot(id, account) : null;
      
      return {
        id: task.taskId,
        title: task.taskId,
        description: taskDescription || 'Complete this task and earn cUSD',
        reward: ethers.formatUnits(task.rewardPerSlot, 18),
        totalSlots: task.totalSlots.toString(),
        claimedSlots: task.claimedSlots.toString(),
        availableSlots: availableSlots.toString(),
        active: task.active,
        creator: task.creator,
        createdAt: new Date(Number(task.createdAt) * 1000),
        mySlot: mySlot ? {
          claimed: mySlot.claimed,
          submitted: mySlot.submitted,
          approved: mySlot.approved,
          withdrawn: mySlot.withdrawn
        } : null
      };
    } catch (error) {
      console.error('Error getting task:', error);
      return null;
    }
  };

  const searchTask = async () => {
    if (!searchQuery || !contract) return;
    
    setLoading(true);
    const task = await getTask(searchQuery);
    
    if (task) {
      // Check if task already exists in list
      const exists = tasks.find(t => t.id === searchQuery);
      if (!exists) {
        setTasks([task, ...tasks]);
      } else {
        // Update existing task
        setTasks(tasks.map(t => t.id === searchQuery ? task : t));
      }
      toast('‚úì Task found!');
    } else {
      toast('‚ùå Task not found');
    }
    
    setLoading(false);
  };

  const loadMyTasks = async () => {
    if (!contract || !account) return;
    
    setLoading(true);
    toast('Loading your tasks...');
    
    const savedTasks = localStorage.getItem(`theoffice_tasks_${account}`);
    if (savedTasks) {
      try {
        const parsed = JSON.parse(savedTasks);
        // Refresh all tasks from blockchain
        const refreshed = [];
        for (const t of parsed) {
          const updated = await getTask(t.id);
          if (updated) {
            refreshed.push(updated);
          }
        }
        setTasks(refreshed);
        toast(`‚úì Loaded ${refreshed.length} tasks`);
      } catch (error) {
        console.error('Error loading tasks:', error);
        toast('Error loading tasks');
      }
    } else {
      toast('No saved tasks found');
    }
    
    setLoading(false);
  };

  const createTask = async () => {
    if (!contract) return;
    
    try {
      setLoading(true);
      toast('Approving cUSD...');

      const ethers = window.ethers;
      const rewardWei = ethers.parseUnits(rewardPerSlot, 18);
      const totalDeposit = rewardWei * BigInt(totalSlots);

      const approveTx = await cUSDContract.approve(CONTRACT_ADDRESS, totalDeposit);
      await approveTx.wait();

      toast('Creating task...');
      const tx = await contract.createTask(taskId, CUSD_ADDRESS, rewardWei, totalSlots, account);
      await tx.wait();
      
      toast('‚úì Task created successfully!');
      
      // Create task object immediately
      const newTask = {
        id: taskId,
        title: taskTitle || taskId,
        description: taskDescription || 'Complete this task and earn cUSD',
        reward: rewardPerSlot,
        totalSlots: totalSlots,
        claimedSlots: '0',
        availableSlots: totalSlots,
        active: true,
        creator: account,
        createdAt: new Date(),
        mySlot: null
      };
      
      // Add to tasks list immediately
      setTasks([newTask, ...tasks]);
      
      setShowCreateModal(false);
      setTaskId('');
      setTaskTitle('');
      setTaskDescription('');
      setRewardPerSlot('');
      setTotalSlots('');
      
      // Fetch from blockchain to get exact data (async)
      setTimeout(async () => {
        const blockchainTask = await getTask(taskId);
        if (blockchainTask) {
          setTasks(prevTasks => {
            const filtered = prevTasks.filter(t => t.id !== taskId);
            return [blockchainTask, ...filtered];
          });
        }
      }, 2000);
      
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const claimTask = async (id) => {
    if (!contract) return;
    
    try {
      setLoading(true);
      toast('Claiming task...');
      
      const tx = await contract.claimTask(id);
      await tx.wait();
      
      toast('‚úì Task claimed!');
      
      // Refresh task
      const updated = await getTask(id);
      if (updated) {
        setTasks(tasks.map(t => t.id === id ? updated : t));
        setSelectedTask(updated);
      }
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const submitTask = async (id, proof) => {
    if (!contract || !proof) return;
    
    try {
      setLoading(true);
      toast('Submitting proof...');
      
      const tx = await contract.submitTask(id, proof);
      await tx.wait();
      
      toast('‚úì Work submitted!');
      setProofUrl('');
      
      // Refresh task
      const updated = await getTask(id);
      if (updated) {
        setTasks(tasks.map(t => t.id === id ? updated : t));
        setSelectedTask(updated);
      }
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const approveTaskSubmission = async (id, claimant) => {
    if (!contract) return;
    
    try {
      setLoading(true);
      toast('Approving submission...');
      
      const tx = await contract.approveTask(id, claimant);
      await tx.wait();
      
      toast('‚úì Submission approved!');
      
      // Refresh task
      const updated = await getTask(id);
      if (updated) {
        setTasks(tasks.map(t => t.id === id ? updated : t));
        setSelectedTask(updated);
      }
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const claimReward = async (id) => {
    if (!contract) return;
    
    try {
      setLoading(true);
      toast('Claiming reward...');
      
      const tx = await contract.claimReward(id);
      await tx.wait();
      
      toast('‚úì Reward claimed!');
      
      // Refresh task
      const updated = await getTask(id);
      if (updated) {
        setTasks(tasks.map(t => t.id === id ? updated : t));
        setSelectedTask(updated);
      }
      
      setShowTaskModal(false);
    } catch (error) {
      console.error(error);
      toast('Error: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const getStatusBadge = (task) => {
    if (!task.mySlot) return { text: 'AVAILABLE', color: colors.green };
    if (task.mySlot.withdrawn) return { text: 'COMPLETED', color: colors.gray[700] };
    if (task.mySlot.approved) return { text: 'APPROVED', color: colors.green };
    if (task.mySlot.submitted) return { text: 'PENDING', color: colors.yellow };
    if (task.mySlot.claimed) return { text: 'CLAIMED', color: colors.purple };
    return { text: 'AVAILABLE', color: colors.green };
  };

  const getTimeAgo = (date) => {
    const seconds = Math.floor((new Date() - date) / 1000);
    const days = Math.floor(seconds / 86400);
    if (days > 0) return `${days}d ago`;
    const hours = Math.floor(seconds / 3600);
    if (hours > 0) return `${hours}h ago`;
    const minutes = Math.floor(seconds / 60);
    return `${minutes}m ago`;
  };

  const handleTaskFilter = (filter) => {
    setTaskFilter(taskFilter === filter ? 'all' : filter);
  };

  const filteredTasks = tasks.filter(task => {
    if (taskFilter === 'all') return true;
    if (taskFilter === 'open') return task.active && Number(task.availableSlots) > 0;
    if (taskFilter === 'my') return task.mySlot && task.mySlot.claimed;
    return true;
  });

  return (
    <div style={{
      minHeight: '100vh',
      backgroundColor: colors.pink,
      paddingBottom: '80px',
      fontFamily: 'Courier, monospace'
    }}>
      {/* Header */}
      <div style={{
        position: 'sticky',
        top: 0,
        backgroundColor: colors.navy,
        padding: '12px 16px',
        borderBottom: `2px solid ${colors.black}`,
        zIndex: 40
      }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          {account && currentPage !== 'home' && (
            <button
              onClick={() => setCurrentPage('home')}
              style={{
                background: 'none',
                border: 'none',
                cursor: 'pointer',
                color: colors.white,
                padding: '4px 8px'
              }}
            >
              <ArrowLeft size={20} />
            </button>
          )}
          
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
            <div style={{
              width: '40px',
              height: '40px',
              backgroundColor: colors.red,
              border: `2px solid ${colors.black}`,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontWeight: 'bold',
              color: colors.white,
              fontSize: '16px'
            }}>
              TO
            </div>
            <div style={{ fontWeight: 'bold', color: colors.white, fontSize: '16px' }}>
              TheOffice
            </div>
          </div>

          {account && (
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <div style={{
                backgroundColor: colors.green,
                padding: '6px 12px',
                fontSize: '12px',
                border: `2px solid ${colors.black}`,
                color: colors.white,
                fontWeight: 'bold'
              }}>
                {balance} cUSD
              </div>
              <button
                onClick={() => {
                  setAccount(null);
                  setContract(null);
                  setCUSDContract(null);
                  setTasks([]);
                  setCurrentPage('home');
                  toast('Logged out');
                }}
                style={{
                  background: 'none',
                  border: 'none',
                  cursor: 'pointer',
                  color: colors.white
                }}
              >
                <LogOut size={20} />
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Main Content */}
      {!account ? (
        <div style={{ padding: '48px 16px', textAlign: 'center' }}>
          <div style={{
            ...styles.card,
            backgroundColor: colors.yellow,
            maxWidth: '500px',
            margin: '0 auto'
          }}>
            <h1 style={{ fontSize: '32px', fontWeight: 'bold', marginBottom: '12px' }}>
              TheOffice
            </h1>
            <p style={{ fontSize: '16px', marginBottom: '20px', color: colors.gray[700] }}>
              AI-powered task creation for every user type
            </p>
            <button
              onClick={connectWallet}
              disabled={loading}
              style={{
                ...styles.button.primary,
                opacity: loading ? 0.7 : 1
              }}
            >
              {loading ? 'Connecting...' : 'Connect Wallet to Start'}
            </button>
          </div>
        </div>
      ) : (
        <>
          {currentPage === 'home' && (
            <div style={{ padding: '20px 16px' }}>
              <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '20px' }}>
                Ol√°! üëã
              </h2>

              <div style={{
                ...styles.card,
                backgroundColor: colors.yellow,
                marginBottom: '20px'
              }}>
                <h3 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '8px' }}>
                  Welcome to TheOffice
                </h3>
                <p style={{ fontSize: '14px', marginBottom: '16px', color: colors.gray[700] }}>
                  Complete tasks, earn cUSD, build your Web3 portfolio
                </p>
                <button
                  onClick={() => setCurrentPage('tasks')}
                  style={styles.button.primary}
                >
                  Browse Tasks
                </button>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: '12px', marginBottom: '20px' }}>
                <div style={styles.card}>
                  <div style={{ fontSize: '24px', marginBottom: '8px' }}>üí∞</div>
                  <h4 style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>Earn cUSD</h4>
                  <p style={{ fontSize: '13px', color: colors.gray[600] }}>Get paid instantly for completed work</p>
                </div>
                <div style={styles.card}>
                  <div style={{ fontSize: '24px', marginBottom: '8px' }}>üöÄ</div>
                  <h4 style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>Multi-Slot Tasks</h4>
                  <p style={{ fontSize: '13px', color: colors.gray[600] }}>Multiple people can work together</p>
                </div>
                <div style={styles.card}>
                  <div style={{ fontSize: '24px', marginBottom: '8px' }}>üîí</div>
                  <h4 style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>Safe Escrow</h4>
                  <p style={{ fontSize: '13px', color: colors.gray[600] }}>Payments secured by smart contract</p>
                </div>
              </div>

              <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                <button
                  onClick={() => setCurrentPage('tasks')}
                  style={{
                    ...styles.button.secondary,
                    textAlign: 'left',
                    width: '100%'
                  }}
                >
                  ‚Üí View Available Tasks
                </button>
                <button
                  onClick={() => setShowCreateModal(true)}
                  style={{
                    ...styles.button.secondary,
                    textAlign: 'left',
                    width: '100%'
                  }}
                >
                  ‚Üí Create New Task
                </button>
              </div>
            </div>
          )}

          {currentPage === 'tasks' && (
            <div style={{ padding: '16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                <h2 style={{ fontWeight: 'bold', fontSize: '20px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  üìã Tasks
                  <Tooltip text="Search for task IDs to view and claim available work">
                    <HelpCircle size={16} color={colors.gray[600]} />
                  </Tooltip>
                </h2>
                <button
                  onClick={() => setShowCreateModal(true)}
                  style={styles.button.primary}
                >
                  + Create
                </button>
              </div>

              <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
                <button
                  onClick={() => handleTaskFilter('all')}
                  style={{
                    ...styles.button.secondary,
                    backgroundColor: taskFilter === 'all' ? colors.navy : colors.white,
                    color: taskFilter === 'all' ? colors.white : colors.navy,
                    padding: '8px 16px',
                    fontSize: '13px'
                  }}
                >
                  All Tasks
                </button>
                <button
                  onClick={() => handleTaskFilter('open')}
                  style={{
                    ...styles.button.secondary,
                    backgroundColor: taskFilter === 'open' ? colors.navy : colors.white,
                    color: taskFilter === 'open' ? colors.white : colors.navy,
                    padding: '8px 16px',
                    fontSize: '13px'
                  }}
                >
                  Open Tasks
                </button>
                <button
                  onClick={() => handleTaskFilter('my')}
                  style={{
                    ...styles.button.secondary,
                    backgroundColor: taskFilter === 'my' ? colors.navy : colors.white,
                    color: taskFilter === 'my' ? colors.white : colors.navy,
                    padding: '8px 16px',
                    fontSize: '13px'
                  }}
                >
                  My Tasks
                </button>
                <button
                  onClick={loadMyTasks}
                  disabled={loading}
                  style={{
                    ...styles.button.secondary,
                    padding: '8px 16px',
                    fontSize: '13px',
                    opacity: loading ? 0.7 : 1
                  }}
                >
                  üîÑ Refresh
                </button>
              </div>

              <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                <input
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && searchTask()}
                  placeholder="Search task by ID..."
                  style={{
                    flex: 1,
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    backgroundColor: colors.white,
                    fontFamily: 'Courier, monospace',
                    fontSize: '14px'
                  }}
                />
                <button
                  onClick={searchTask}
                  disabled={loading}
                  style={{
                    ...styles.button.secondary,
                    padding: '10px 20px'
                  }}
                >
                  {loading ? <Loader2 size={18} className="animate-spin" /> : <Search size={18} />}
                </button>
              </div>

              {filteredTasks.length === 0 ? (
                <div style={{
                  ...styles.card,
                  textAlign: 'center',
                  padding: '40px 20px'
                }}>
                  <div style={{ fontSize: '40px', marginBottom: '12px' }}>üîç</div>
                  <p style={{ fontWeight: 'bold', marginBottom: '4px' }}>No tasks found</p>
                  <p style={{ fontSize: '13px', color: colors.gray[600] }}>
                    Search for a task ID or create a new one
                  </p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {filteredTasks.map((task, idx) => {
                    const status = getStatusBadge(task);
                    return (
                      <div key={idx} style={{
                        ...styles.card,
                        cursor: 'pointer'
                      }} onClick={() => {
                        setSelectedTask(task);
                        setShowTaskModal(true);
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                          <div style={{ flex: 1 }}>
                            <h3 style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>{task.title}</h3>
                            <p style={{ fontSize: '13px', color: colors.gray[600], marginBottom: '8px' }}>{task.description}</p>
                            
                            <div style={{ display: 'flex', gap: '12px', fontSize: '12px', marginBottom: '8px' }}>
                              <span>üí∞ {task.reward} cUSD</span>
                              <span>üë• {task.availableSlots}/{task.totalSlots} slots</span>
                              <span>‚è∞ {getTimeAgo(task.createdAt)}</span>
                            </div>

                            <span style={{
                              display: 'inline-block',
                              padding: '4px 12px',
                              fontSize: '11px',
                              fontWeight: 'bold',
                              backgroundColor: status.color,
                              color: colors.white,
                              borderRadius: '12px'
                            }}>
                              {status.text}
                            </span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {currentPage === 'profile' && (
            <div style={{ padding: '20px 16px' }}>
              <div style={{
                ...styles.card,
                backgroundColor: colors.purple,
                marginBottom: '20px',
                color: colors.white
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                  <div style={{
                    width: '60px',
                    height: '60px',
                    backgroundColor: colors.red,
                    border: `2px solid ${colors.black}`,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '20px',
                    fontWeight: 'bold'
                  }}>
                    TO
                  </div>
                  <div>
                    <div style={{ fontSize: '11px', opacity: 0.8 }}>WALLET ADDRESS</div>
                    <div style={{ fontWeight: 'bold', fontSize: '14px' }}>
                      {account?.slice(0, 8)}...{account?.slice(-6)}
                    </div>
                  </div>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '10px' }}>
                  <div style={{
                    ...styles.card,
                    textAlign: 'center',
                    padding: '12px 8px'
                  }}>
                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: colors.navy }}>{tasks.filter(t => t.mySlot?.claimed).length}</div>
                    <div style={{ fontSize: '11px', color: colors.gray[600] }}>Tasks</div>
                  </div>
                  <div style={{
                    ...styles.card,
                    textAlign: 'center',
                    padding: '12px 8px'
                  }}>
                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: colors.green }}>{balance}</div>
                    <div style={{ fontSize: '11px', color: colors.gray[600] }}>cUSD</div>
                  </div>
                  <div style={{
                    ...styles.card,
                    textAlign: 'center',
                    padding: '12px 8px'
                  }}>
                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: colors.yellow }}>‚òÖ‚òÖ‚òÖ</div>
                    <div style={{ fontSize: '11px', color: colors.gray[600] }}>Rating</div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </>
      )}

      {/* Bottom Nav */}
      {account && (
        <div style={{
          position: 'fixed',
          bottom: 0,
          left: 0,
          right: 0,
          backgroundColor: colors.navy,
          borderTop: `2px solid ${colors.black}`,
          display: 'flex',
          zIndex: 40
        }}>
          {[
            { id: 'home', icon: Home, label: 'Home' },
            { id: 'tasks', icon: Clipboard, label: 'Tasks' },
            { id: 'profile', icon: User, label: 'Profile' }
          ].map(tab => {
            const Icon = tab.icon;
            return (
              <button
                key={tab.id}
                onClick={() => setCurrentPage(tab.id)}
                style={{
                  flex: 1,
                  padding: '14px',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px',
                  backgroundColor: currentPage === tab.id ? colors.purple : 'transparent',
                  border: 'none',
                  cursor: 'pointer'
                }}
              >
                <Icon size={22} color={colors.white} />
                <span style={{ fontSize: '11px', color: colors.white }}>{tab.label}</span>
              </button>
            );
          })}
        </div>
      )}

      {/* Create Modal */}
      {showCreateModal && (
        <div style={{
          position: 'fixed',
          inset: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '16px',
          zIndex: 50
        }}>
          <div style={{
            backgroundColor: colors.white,
            border: `2px solid ${colors.black}`,
            padding: '24px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '90vh',
            overflowY: 'auto'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ fontWeight: 'bold', fontSize: '18px' }}>Create New Task</h2>
              <button onClick={() => setShowCreateModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer' }}>
                <X size={24} />
              </button>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div>
                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>TASK ID</label>
                <input
                  value={taskId}
                  onChange={(e) => setTaskId(e.target.value)}
                  placeholder="unique-task-id"
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    fontFamily: 'Courier, monospace'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>TITLE</label>
                <input
                  value={taskTitle}
                  onChange={(e) => setTaskTitle(e.target.value)}
                  placeholder="Task title"
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    fontFamily: 'Courier, monospace'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>DESCRIPTION</label>
                <textarea
                  value={taskDescription}
                  onChange={(e) => setTaskDescription(e.target.value)}
                  placeholder="Task description"
                  rows="3"
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    fontFamily: 'Courier, monospace'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>REWARD (cUSD)</label>
                <input
                  type="number"
                  value={rewardPerSlot}
                  onChange={(e) => setRewardPerSlot(e.target.value)}
                  placeholder="10"
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    fontFamily: 'Courier, monospace'
                  }}
                />
              </div>

              <div>
                <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>SLOTS</label>
                <input
                  type="number"
                  value={totalSlots}
                  onChange={(e) => setTotalSlots(e.target.value)}
                  placeholder="5"
                  style={{
                    width: '100%',
                    padding: '10px',
                    border: `2px solid ${colors.gray[300]}`,
                    fontFamily: 'Courier, monospace'
                  }}
                />
              </div>

              {rewardPerSlot && totalSlots && (
                <div style={{
                  backgroundColor: colors.yellow,
                  border: `2px solid ${colors.black}`,
                  padding: '12px'
                }}>
                  <div style={{ fontWeight: 'bold', fontSize: '12px' }}>Total Cost:</div>
                  <div style={{ fontSize: '18px', fontWeight: 'bold' }}>
                    {(parseFloat(rewardPerSlot) * parseInt(totalSlots)).toFixed(2)} cUSD
                  </div>
                </div>
              )}

              <button
                onClick={createTask}
                disabled={loading || !taskId || !rewardPerSlot || !totalSlots}
                style={{
                  ...styles.button.primary,
                  width: '100%',
                  opacity: (loading || !taskId || !rewardPerSlot || !totalSlots) ? 0.5 : 1
                }}
              >
                {loading ? 'CREATING...' : 'CREATE TASK'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Task Detail Modal */}
      {showTaskModal && selectedTask && (
        <div style={{
          position: 'fixed',
          inset: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '16px',
          zIndex: 50
        }}>
          <div style={{
            backgroundColor: colors.white,
            border: `2px solid ${colors.black}`,
            padding: '24px',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '90vh',
            overflowY: 'auto'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
              <h2 style={{ fontWeight: 'bold', fontSize: '18px' }}>{selectedTask.title}</h2>
              <button onClick={() => setShowTaskModal(false)} style={{ background: 'none', border: 'none', cursor: 'pointer' }}>
                <X size={24} />
              </button>
            </div>

            <p style={{ fontSize: '14px', marginBottom: '16px', color: colors.gray[700] }}>
              {selectedTask.description}
            </p>

            <div style={{
              backgroundColor: colors.gray[50],
              border: `2px solid ${colors.gray[300]}`,
              padding: '12px',
              marginBottom: '16px'
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                <span style={{ fontSize: '13px' }}>Reward:</span>
                <span style={{ fontWeight: 'bold' }}>{selectedTask.reward} cUSD</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span style={{ fontSize: '13px' }}>Available Slots:</span>
                <span style={{ fontWeight: 'bold' }}>{selectedTask.availableSlots}/{selectedTask.totalSlots}</span>
              </div>
            </div>

            {/* Actions */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {!selectedTask.mySlot?.claimed && selectedTask.active && Number(selectedTask.availableSlots) > 0 && (
                <button
                  onClick={() => claimTask(selectedTask.id)}
                  disabled={loading}
                  style={{
                    ...styles.button.primary,
                    width: '100%',
                    opacity: loading ? 0.7 : 1
                  }}
                >
                  {loading ? 'CLAIMING...' : 'CLAIM TASK'}
                </button>
              )}

              {selectedTask.mySlot?.claimed && !selectedTask.mySlot?.submitted && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                  <input
                    value={proofUrl}
                    onChange={(e) => setProofUrl(e.target.value)}
                    placeholder="Proof URL (IPFS, Google Drive, etc.)"
                    style={{
                      width: '100%',
                      padding: '10px',
                      border: `2px solid ${colors.gray[300]}`,
                      fontFamily: 'Courier, monospace'
                    }}
                  />
                  <button
                    onClick={() => submitTask(selectedTask.id, proofUrl)}
                    disabled={loading || !proofUrl}
                    style={{
                      ...styles.button.primary,
                      width: '100%',
                      opacity: (loading || !proofUrl) ? 0.7 : 1
                    }}
                  >
                    {loading ? 'SUBMITTING...' : 'SUBMIT WORK'}
                  </button>
                </div>
              )}

              {selectedTask.mySlot?.submitted && !selectedTask.mySlot?.approved && (
                <div style={{
                  backgroundColor: colors.yellow,
                  border: `2px solid ${colors.black}`,
                  padding: '12px',
                  textAlign: 'center',
                  fontWeight: 'bold'
                }}>
                  ‚è≥ Waiting for approval...
                </div>
              )}

              {selectedTask.mySlot?.approved && !selectedTask.mySlot?.withdrawn && (
                <button
                  onClick={() => claimReward(selectedTask.id)}
                  disabled={loading}
                  style={{
                    ...styles.button.primary,
                    width: '100%',
                    backgroundColor: colors.green,
                    opacity: loading ? 0.7 : 1
                  }}
                >
                  {loading ? 'CLAIMING...' : 'CLAIM REWARD'}
                </button>
              )}

              {selectedTask.mySlot?.withdrawn && (
                <div style={{
                  backgroundColor: colors.green,
                  border: `2px solid ${colors.black}`,
                  padding: '12px',
                  textAlign: 'center',
                  fontWeight: 'bold',
                  color: colors.white
                }}>
                  ‚úì Reward claimed!
                </div>
              )}

              {selectedTask.creator.toLowerCase() === account.toLowerCase() && (
                <div style={{
                  marginTop: '16px',
                  padding: '12px',
                  backgroundColor: colors.gray[50],
                  border: `2px solid ${colors.gray[300]}`
                }}>
                  <div style={{ fontWeight: 'bold', marginBottom: '8px', fontSize: '12px' }}>TASK CREATOR ACTIONS</div>
                  <input
                    placeholder="Claimant address (0x...)"
                    style={{
                      width: '100%',
                      padding: '8px',
                      border: `2px solid ${colors.gray[300]}`,
                      marginBottom: '8px',
                      fontFamily: 'Courier, monospace',
                      fontSize: '12px'
                    }}
                    id="approveAddress"
                  />
                  <button
                    onClick={() => {
                      const addr = document.getElementById('approveAddress').value;
                      if (addr) approveTaskSubmission(selectedTask.id, addr);
                    }}
                    disabled={loading}
                    style={{
                      ...styles.button.secondary,
                      width: '100%',
                      fontSize: '12px',
                      padding: '8px'
                    }}
                  >
                    APPROVE SUBMISSION
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Toast */}
      {showToast && (
        <div style={{
          position: 'fixed',
          top: '80px',
          left: '50%',
          transform: 'translateX(-50%)',
          backgroundColor: colors.yellow,
          border: `2px solid ${colors.black}`,
          padding: '12px 24px',
          fontWeight: 'bold',
          zIndex: 50,
          fontSize: '14px'
        }}>
          {showToast}
        </div>
      )}
    </div>
  );
}

export default App;
